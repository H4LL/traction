services:
  ngrok-traction-agent:
    image: ngrok/ngrok
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
      - TRACTION_ACAPY_HTTP_PORT=${TRACTION_ACAPY_HTTP_PORT}
    ports:
      - 4052:4040
    networks:
      - traction-network
    command: http traction-agent:${TRACTION_ACAPY_HTTP_PORT} --log stdout

  traction-acapy-image-builder:
    pull_policy: missing
    build:
      context: ../plugins
      dockerfile: ./docker/Dockerfile
    image: traction:plugins-acapy
    entrypoint: "/bin/bash"
    tty: true
    networks:
      - traction-network

  traction-agent:
    pull_policy: missing
    build:
      context: ../services/aca-py
      dockerfile: Dockerfile.acapy
    image: traction:traction-agent
    depends_on:
      traction-acapy-image-builder:
        condition: service_started
      traction-db:
        condition: service_healthy
      did-registrar:
        condition: service_started
    environment:
      - TRACTION_ENV=${TRACTION_ENV}
      - NGROK_NAME=ngrok-traction-agent
      - ACAPY_ENDPOINT=${ACAPY_ENDPOINT}
      - TRACTION_ACAPY_HTTP_PORT=${TRACTION_ACAPY_HTTP_PORT}
      - TRACTION_ACAPY_ADMIN_PORT=${TRACTION_ACAPY_ADMIN_PORT}
      - TRACTION_ACAPY_WALLET_NAME=${TRACTION_ACAPY_WALLET_NAME}
      - TRACTION_ACAPY_WALLET_ENCRYPTION_KEY=${TRACTION_ACAPY_WALLET_ENCRYPTION_KEY}
      - TRACTION_ACAPY_WALLET_SCHEME=${TRACTION_ACAPY_WALLET_SCHEME}
      - POSTGRESQL_HOST=${POSTGRESQL_HOST}
      - POSTGRESQL_USER=${POSTGRESQL_USER}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - TRACTION_MULTITENANCY_CONFIGURATION_WALLET_TYPE=${TRACTION_MULTITENANCY_CONFIGURATION_WALLET_TYPE}
      - TRACTION_MULTITENANCY_CONFIGURATION_WALLET_NAME=${TRACTION_MULTITENANCY_CONFIGURATION_WALLET_NAME}
      - ACAPY_LOG_LEVEL=${ACAPY_LOG_LEVEL}
      - ACAPY_AUTO_PROVISION=${ACAPY_AUTO_PROVISION}
      - ACAPY_WALLET_TYPE=${ACAPY_WALLET_TYPE}
      - ACAPY_WALLET_STORAGE_TYPE=${ACAPY_WALLET_STORAGE_TYPE}
      - ACAPY_LABEL=${ACAPY_LABEL}
      - ACAPY_ADMIN_API_KEY=${ACAPY_ADMIN_API_KEY}
      - ACAPY_ADMIN_INSECURE_MODE=${ACAPY_ADMIN_INSECURE_MODE}
      - ACAPY_AUTO_ACCEPT_INVITES=${ACAPY_AUTO_ACCEPT_INVITES}
      - ACAPY_AUTO_ACCEPT_REQUESTS=${ACAPY_AUTO_ACCEPT_REQUESTS}
      - ACAPY_AUTO_RESPOND_MESSAGES=${ACAPY_AUTO_RESPOND_MESSAGES}
      - ACAPY_AUTO_RESPOND_CREDENTIAL_PROPOSAL=${ACAPY_AUTO_RESPOND_CREDENTIAL_PROPOSAL}
      - ACAPY_AUTO_RESPOND_CREDENTIAL_OFFER=${ACAPY_AUTO_RESPOND_CREDENTIAL_OFFER}
      - ACAPY_AUTO_RESPOND_CREDENTIAL_REQUEST=${ACAPY_AUTO_RESPOND_CREDENTIAL_REQUEST}
      - ACAPY_AUTO_RESPOND_PRESENTATION_PROPOSAL=${ACAPY_AUTO_RESPOND_PRESENTATION_PROPOSAL}
      - ACAPY_AUTO_RESPOND_PRESENTATION_REQUEST=${ACAPY_AUTO_RESPOND_PRESENTATION_REQUEST}
      - ACAPY_AUTO_VERIFY_PRESENTATION=${ACAPY_AUTO_VERIFY_PRESENTATION}
      - ACAPY_AUTO_PING_CONNECTION=${ACAPY_AUTO_PING_CONNECTION}
      - ACAPY_MONITOR_PING=${ACAPY_MONITOR_PING}
      - ACAPY_PUBLIC_INVITES=${ACAPY_PUBLIC_INVITES}
      - ACAPY_MULTITENANT=${ACAPY_MULTITENANT}
      - ACAPY_MULTITENANT_ADMIN=${ACAPY_MULTITENANT_ADMIN}
      - ACAPY_MULTITENANT_JWT_SECRET=${ACAPY_MULTITENANT_JWT_SECRET}
      - ACAPY_MULTITENANCY_CONFIGURATION=${ACAPY_MULTITENANCY_CONFIGURATION}
      - ACAPY_EMIT_NEW_DIDCOMM_PREFIX=${ACAPY_EMIT_NEW_DIDCOMM_PREFIX}
      - ACAPY_EMIT_NEW_DIDCOMM_MIME_TYPE=${ACAPY_EMIT_NEW_DIDCOMM_MIME_TYPE}
      - ACAPY_TAILS_SERVER_BASE_URL=${ACAPY_TAILS_SERVER_BASE_URL}
      - ACAPY_TAILS_SERVER_UPLOAD_URL=${ACAPY_TAILS_SERVER_UPLOAD_URL}
      - ACAPY_PRESERVE_EXCHANGE_RECORDS=${ACAPY_PRESERVE_EXCHANGE_RECORDS}
      - ACAPY_AUTO_STORE_CREDENTIAL=${ACAPY_AUTO_STORE_CREDENTIAL}
      - ACAPY_NOTIFY_REVOCATION=${ACAPY_NOTIFY_REVOCATION}
      - ACAPY_MONITOR_REVOCATION_NOTIFICATION=${ACAPY_MONITOR_REVOCATION_NOTIFICATION}
      - ACAPY_CREATE_REVOCATION_TRANSACTIONS=${ACAPY_CREATE_REVOCATION_TRANSACTIONS}
      - ACAPY_DEBUG_WEBHOOKS=${ACAPY_DEBUG_WEBHOOKS}
      - ACAPY_PLUGIN_CONFIG=${ACAPY_PLUGIN_CONFIG}
      - RUST_LOG=error
    # Ports removed - access via tenant-proxy only
    entrypoint: /bin/bash
    command: ["-c", "sleep 5; ./ngrok-wait.sh"]
    volumes:
      - "./plugin-config.yml:/home/aries/plugin-config.yml"
      - "./empty-genesis.json:/home/aries/empty-genesis.json"
    networks:
      - traction-network
    extra_hosts:
      - host.docker.internal:host-gateway

  traction-db:
    image: "postgres:15"
    environment:
      - POSTGRES_USER=${POSTGRESQL_USER}
      - POSTGRES_PASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRES_DB=${POSTGRESQL_DB}
    # Port removed - internal access only via traction-network
    volumes:
      - traction-wallet:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - traction-network
    extra_hosts:
      - host.docker.internal:host-gateway

  tenant-ui:
    pull_policy: missing
    build:
      context: ../services/tenant-ui
      dockerfile: Dockerfile
    image: traction:tenant-ui
    depends_on:
      tenant-proxy:
        condition: service_started
    networks:
      - traction-network
    environment:
      - SERVER_TRACTION_URL=${SERVER_TRACTION_URL}
      - SERVER_LOKI_URL=${SERVER_LOKI_URL}
      - FRONTEND_TENANT_PROXY_URL=${FRONTEND_TENANT_PROXY_URL}
      - FRONTEND_LOG_STREAM_URL=${FRONTEND_LOG_STREAM_URL}
      - IMAGE_BUILDTIME=${IMAGE_BUILDTIME}
      - IMAGE_TAG=${IMAGE_TAG}
      - IMAGE_VERSION=${IMAGE_VERSION}
      - UX_APP_TITLE=${UX_APP_TITLE}
      - UX_APP_INNKEEPER_TITLE=${UX_APP_INNKEEPER_TITLE}
      - UX_SIDEBAR_TITLE=${UX_SIDEBAR_TITLE}
      - UX_COPYRIGHT=${UX_COPYRIGHT}
      - UX_OWNER=${UX_OWNER}
      - FRONTEND_QUICK_CONNECT_ENDORSER_NAME=${FRONTEND_QUICK_CONNECT_ENDORSER_NAME}
      - SERVER_SMTP_SERVER=maildev
      - SERVER_SMTP_PORT=1025
    ports:
      - ${TENANT_UI_PORT}:8080
    ###############################################
    # Comment the following out if you want to use the default reservation form
    volumes:
      - ../services/tenant-ui/config/forms:/usr/src/app/frontend/dist/forms
    ###############################################
    extra_hosts:
      - host.docker.internal:host-gateway

  tenant-proxy:
    pull_policy: missing
    build:
      context: ../plugins
      dockerfile: ./docker/Dockerfile.tenant-proxy
    image: traction:tenant-proxy
    depends_on:
      traction-agent:
        condition: service_started
      did-registrar:
        condition: service_started
    restart: unless-stopped
    environment:
      - ACAPY_ADMIN_URL=${TRACTION_ACAPY_ADMIN_URL}
      - ACAPY_ADMIN_URL_API_KEY=${ACAPY_ADMIN_API_KEY}
    ports:
      - ${TENANT_PROXY_PORT}:8080
    networks:
      - traction-network
    extra_hosts:
      - host.docker.internal:host-gateway

  # cheqd DID Services
  did-registrar:
    image: ghcr.io/cheqd/did-registrar:production-latest
    platform: linux/amd64
    ports:
      - "9089:3000"
    restart: on-failure
    environment:
      - FEE_PAYER_TESTNET_MNEMONIC=${FEE_PAYER_TESTNET_MNEMONIC:-"abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon art"}
      - FEE_PAYER_MAINNET_MNEMONIC=${FEE_PAYER_MAINNET_MNEMONIC:-"abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon art"}
    networks:
      - traction-network
    extra_hosts:
      - host.docker.internal:host-gateway

  did-resolver:
    image: ghcr.io/cheqd/did-resolver:latest
    platform: linux/amd64
    ports:
      - "8081:8080"
    restart: on-failure
    environment:
      - MAINNET_ENDPOINT=grpc.cheqd.network:443,true,5s
      - TESTNET_ENDPOINT=grpc.cheqd.network:443,true,5s  
      - LOG_LEVEL=info
      - RESOLVER_LISTENER=0.0.0.0:8080
      - ENABLE_FALLBACK_ENDPOINTS=false
    networks:
      - traction-network
    extra_hosts:
      - host.docker.internal:host-gateway

  maildev:
    image: maildev/maildev
    ports:
      - "1080:1080"
      - "1025:1025"
    networks:
      - traction-network

volumes:
  traction-wallet:
  # Removed endorser volumes for cheqd integration

networks:
  traction-network:
    driver: bridge
    name: traction-network
